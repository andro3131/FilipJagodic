<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin — Filip Jagodič</title>
<meta name="robots" content="noindex, nofollow">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0a0c;--surface:#141618;--accent:#D44040;--text:#f0f0f0;
  --muted:#a0a0a0;--border:rgba(255,255,255,0.1);--radius:8px;
  --sidebar-w:240px;--danger:#e74c3c;--success:#27ae60;
}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh}
a{color:var(--accent);text-decoration:none}
input,textarea,select,button{font-family:inherit;font-size:inherit}
input[type=text],input[type=number],input[type=password],input[type=url],textarea{
  width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);
  border-radius:var(--radius);color:var(--text);outline:none;transition:border .2s;
}
input:focus,textarea:focus{border-color:var(--accent)}
textarea{resize:vertical;min-height:80px}
label{display:block;margin-bottom:4px;font-size:.875rem;color:var(--muted)}
.field{margin-bottom:16px}

/* Buttons */
.btn{
  display:inline-flex;align-items:center;gap:6px;padding:10px 20px;border:none;
  border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:.875rem;
  transition:opacity .2s,transform .1s;
}
.btn:active{transform:scale(.97)}
.btn-accent{background:var(--accent);color:#fff}
.btn-accent:hover{opacity:.9}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-danger{background:var(--danger);color:#fff}
.btn-danger:hover{opacity:.9}
.btn-sm{padding:6px 12px;font-size:.8rem}

/* Login */
#login-screen{
  display:flex;align-items:center;justify-content:center;min-height:100vh;
}
.login-box{
  background:var(--surface);padding:40px;border-radius:12px;width:360px;
  border:1px solid var(--border);text-align:center;
}
.login-box h1{font-size:1.5rem;margin-bottom:8px}
.login-box p{color:var(--muted);margin-bottom:24px;font-size:.9rem}
.login-box .field{text-align:left}
.login-error{color:var(--danger);font-size:.85rem;margin-top:8px;min-height:20px}

/* Layout */
#app{display:none}
.sidebar{
  position:fixed;top:0;left:0;width:var(--sidebar-w);height:100vh;
  background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;z-index:100;
}
.sidebar-header{padding:20px;border-bottom:1px solid var(--border)}
.sidebar-header h2{font-size:1.1rem;color:var(--accent)}
.sidebar-header small{color:var(--muted);font-size:.75rem}
.sidebar-nav{flex:1;overflow-y:auto;padding:8px 0}
.sidebar-nav button{
  display:block;width:100%;text-align:left;padding:10px 20px;background:none;
  border:none;color:var(--muted);cursor:pointer;font-size:.9rem;transition:all .15s;
}
.sidebar-nav button:hover{color:var(--text);background:rgba(255,255,255,.04)}
.sidebar-nav button.active{color:var(--accent);background:rgba(212,64,64,.08);border-right:3px solid var(--accent)}
.sidebar-footer{padding:16px 20px;border-top:1px solid var(--border)}
.sidebar-footer button{
  background:none;border:none;color:var(--muted);cursor:pointer;font-size:.85rem;
}
.sidebar-footer button:hover{color:var(--danger)}

.main{margin-left:var(--sidebar-w);padding:32px 40px;max-width:960px}
.main h1{font-size:1.75rem;margin-bottom:24px;padding-bottom:12px;border-bottom:1px solid var(--border)}
.section-content{display:none}
.section-content.active{display:block}

/* Cards */
.card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:20px;margin-bottom:16px;
}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.card-header h3{font-size:1rem}

/* Image preview */
.img-preview{
  width:120px;height:90px;object-fit:cover;border-radius:6px;border:1px solid var(--border);
  background:var(--bg);cursor:pointer;
}
.img-preview-sm{width:80px;height:60px}
.img-preview-lg{width:180px;height:135px}
.img-row{display:flex;align-items:center;gap:12px;margin-bottom:8px;flex-wrap:wrap}

/* Sticky save — fixed at top right */
.save-bar{
  position:sticky;top:0;background:var(--surface);border-bottom:1px solid var(--border);
  padding:12px 0;margin-bottom:24px;z-index:50;display:flex;gap:12px;align-items:center;
}

/* Move buttons */
.btn-move{
  background:none;border:1px solid var(--border);color:var(--muted);cursor:pointer;
  padding:4px 8px;border-radius:4px;font-size:.75rem;line-height:1;
}
.btn-move:hover{border-color:var(--accent);color:var(--accent)}

/* Highlight new item */
@keyframes highlightNew{from{border-color:var(--accent);box-shadow:0 0 12px rgba(212,64,64,.3)}to{border-color:var(--border);box-shadow:none}}
.card-new{animation:highlightNew 1.5s ease}

/* Toast */
.toast-container{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{
  padding:12px 20px;border-radius:var(--radius);color:#fff;font-size:.9rem;
  animation:toastIn .3s ease;min-width:260px;box-shadow:0 4px 20px rgba(0,0,0,.4);
}
.toast-success{background:var(--success)}
.toast-error{background:var(--danger)}
@keyframes toastIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

/* Dynamic list */
.list-item{
  display:flex;align-items:flex-start;gap:12px;padding:12px;background:var(--bg);
  border:1px solid var(--border);border-radius:var(--radius);margin-bottom:8px;
}
.list-item .list-fields{flex:1}
.list-item .list-fields .field{margin-bottom:8px}

/* Translations */
.trans-section{margin-bottom:16px}
.trans-section-header{
  display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--surface);
  border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;
  font-weight:600;font-size:.95rem;user-select:none;
}
.trans-section-header:hover{border-color:var(--accent)}
.trans-section-header .arrow{transition:transform .2s;font-size:.7rem}
.trans-section-header.open .arrow{transform:rotate(90deg)}
.trans-body{display:none;padding:12px;border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius) var(--radius)}
.trans-body.open{display:block}
.trans-row{display:grid;grid-template-columns:200px 1fr 1fr;gap:12px;align-items:start;padding:8px 0;border-bottom:1px solid var(--border)}
.trans-row:last-child{border-bottom:none}
.trans-key{font-size:.8rem;color:var(--accent);word-break:break-all;padding-top:8px}

/* Checkbox list */
.check-list{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.check-item{
  display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg);
  border:1px solid var(--border);border-radius:var(--radius);font-size:.85rem;
}
.check-item input[type=checkbox]{accent-color:var(--accent)}

/* Albums */
.album-images{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}

/* History modal */
.modal-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);
  z-index:9000;display:flex;align-items:center;justify-content:center;
  animation:fadeIn .2s ease;
}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-box{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  width:600px;max-width:90vw;max-height:80vh;display:flex;flex-direction:column;
  box-shadow:0 8px 40px rgba(0,0,0,.5);
}
.modal-header{
  display:flex;align-items:center;justify-content:space-between;padding:20px 24px;
  border-bottom:1px solid var(--border);
}
.modal-header h2{font-size:1.1rem;margin:0}
.modal-close{
  background:none;border:none;color:var(--muted);font-size:1.5rem;cursor:pointer;
  padding:0 4px;line-height:1;
}
.modal-close:hover{color:var(--text)}
.modal-body{flex:1;overflow-y:auto;padding:16px 24px}
.history-item{
  display:flex;align-items:center;gap:12px;padding:14px 16px;
  border:1px solid var(--border);border-radius:var(--radius);margin-bottom:8px;
  cursor:pointer;transition:all .15s;
}
.history-item:hover{border-color:var(--accent);background:rgba(212,64,64,.06)}
.history-item.current{border-color:var(--success);background:rgba(39,174,96,.08)}
.history-meta{flex:1;min-width:0}
.history-date{font-size:.85rem;font-weight:600;color:var(--text)}
.history-msg{font-size:.8rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.history-badge{
  font-size:.7rem;font-weight:700;padding:3px 8px;border-radius:4px;white-space:nowrap;
}
.history-badge-current{background:var(--success);color:#fff}
.history-badge-restore{background:var(--accent);color:#fff}
.history-loading{text-align:center;padding:40px;color:var(--muted)}

/* History button */
.btn-history{background:transparent;border:1px solid var(--border);color:var(--muted)}
.btn-history:hover{border-color:var(--accent);color:var(--accent)}

/* Inline translation pair divider */
.trans-pair-group{margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
.trans-pair-group h4{font-size:.9rem;color:var(--accent);margin-bottom:12px}

/* Translate button */
.btn-translate{
  background:none;border:1px solid var(--border);color:var(--accent);cursor:pointer;
  padding:2px 8px;border-radius:4px;font-size:.7rem;font-weight:600;
  white-space:nowrap;transition:all .15s;line-height:1.4;
}
.btn-translate:hover{background:var(--accent);color:#fff}
.btn-translate:disabled{opacity:.4;cursor:wait}
</style>
</head>
<body>

<!-- Login Screen -->
<div id="login-screen">
  <div class="login-box">
    <h1>Filip Jagodič</h1>
    <p>Admin Panel</p>
    <div class="field">
      <label for="login-pw">Geslo</label>
      <input type="password" id="login-pw" placeholder="Vnesite geslo..." onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="btn btn-accent" style="width:100%;margin-top:8px" onclick="doLogin()">Prijava</button>
    <div class="login-error" id="login-error"></div>
  </div>
</div>

<!-- App -->
<div id="app">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Filip Jagodič</h2>
      <small>Administracija</small>
    </div>
    <div class="sidebar-nav" id="sidebar-nav"></div>
    <div class="sidebar-footer">
      <button onclick="doLogout()">&#x2190; Odjava</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <div id="section-hero" class="section-content"></div>
    <div id="section-about" class="section-content"></div>
    <div id="section-encounters" class="section-content"></div>
    <div id="section-gallery" class="section-content"></div>
    <div id="section-music" class="section-content"></div>
    <div id="section-studio" class="section-content"></div>
    <div id="section-collections" class="section-content"></div>
    <div id="section-biography" class="section-content"></div>
    <div id="section-contact" class="section-content"></div>
    <div id="section-translations" class="section-content"></div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<script>
/* =========================================================
   ADMIN PANEL — Filip Jagodič
   ========================================================= */

// ---- Config ----
const CLOUDINARY_CLOUD = 'dewf3zos0';
const CLOUDINARY_PRESET = 'Filip_galerija';

const SECTIONS = [
  { key: 'hero',         file: 'hero',         label: 'Junak' },
  { key: 'about',        file: 'about',        label: 'O Filipu' },
  { key: 'encounters',   file: 'encounters',   label: 'Srečanja' },
  { key: 'gallery',      file: 'gallery',      label: 'Galerija' },
  { key: 'music',        file: 'music',        label: 'Glasba' },
  { key: 'studio',       file: 'studio',       label: 'V studiu' },
  { key: 'collections',  file: 'collections',  label: 'Zbirke' },
  { key: 'biography',    file: 'biography',    label: 'Življenjepis' },
  { key: 'contact',      file: 'contact',      label: 'Kontakt' },
  { key: 'translations', file: null,           label: 'Prevodi' },
];

let sectionData = {};
let currentSection = 'hero';
let translationsSl = null;
let translationsEn = null;
let translationsSlSha = null;
let translationsEnSha = null;

// ---- Helpers ----
function val(id) { return document.getElementById(id)?.value || ''; }
function esc(s) { return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function getToken() { return sessionStorage.getItem('admin_token') || ''; }

function scrollToNew(containerId) {
  setTimeout(() => {
    const el = document.querySelector('#' + containerId + ' .card-new');
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 50);
}

function moveItem(arr, from, to) {
  if (to < 0 || to >= arr.length) return;
  const item = arr.splice(from, 1)[0];
  arr.splice(to, 0, item);
}

function showToast(msg, type='success') {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast toast-' + type;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { t.style.opacity='0'; t.style.transition='opacity .3s'; setTimeout(()=>t.remove(),300); }, 3000);
}

// ---- Translation helpers ----
function getTransVal(lang, path) {
  const obj = lang === 'sl' ? translationsSl : translationsEn;
  if (!obj) return '';
  const keys = path.split('.');
  let val = obj;
  for (const k of keys) {
    if (val === undefined || val === null) return '';
    val = val[k];
  }
  return val || '';
}

function renderTransPair(label, path, opts) {
  opts = opts || {};
  const slVal = getTransVal('sl', path);
  const enVal = getTransVal('en', path);
  const isLong = opts.textarea || String(slVal).length > 80 || String(enVal).length > 80;
  const tBtn = '<button class="btn-translate" onclick="event.stopPropagation();translateField(this)" title="Prevedi SL \u2192 EN">\u2192 EN</button>';

  if (isLong) {
    return '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
      '<div class="field"><label>SL: ' + esc(label) + '</label>' +
        '<textarea data-trans-path="' + esc(path) + '" data-trans-lang="sl" rows="3">' + esc(slVal) + '</textarea></div>' +
      '<div class="field"><label style="display:flex;justify-content:space-between;align-items:center"><span>EN: ' + esc(label) + '</span> ' + tBtn + '</label>' +
        '<textarea data-trans-path="' + esc(path) + '" data-trans-lang="en" rows="3">' + esc(enVal) + '</textarea></div>' +
    '</div>';
  }
  return '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
    '<div class="field"><label>SL: ' + esc(label) + '</label>' +
      '<input type="text" data-trans-path="' + esc(path) + '" data-trans-lang="sl" value="' + esc(slVal) + '"></div>' +
    '<div class="field"><label style="display:flex;justify-content:space-between;align-items:center"><span>EN: ' + esc(label) + '</span> ' + tBtn + '</label>' +
      '<input type="text" data-trans-path="' + esc(path) + '" data-trans-lang="en" value="' + esc(enVal) + '"></div>' +
  '</div>';
}

function setNestedValue(obj, path, value) {
  const keys = path.split('.');
  let current = obj;
  for (let i = 0; i < keys.length - 1; i++) {
    if (current[keys[i]] === undefined || typeof current[keys[i]] !== 'object') {
      current[keys[i]] = {};
    }
    current = current[keys[i]];
  }
  current[keys[keys.length - 1]] = value;
}

async function saveInlineTranslations() {
  const inputs = document.querySelectorAll('[data-trans-path]');
  if (inputs.length === 0) return;

  const sl = JSON.parse(JSON.stringify(translationsSl));
  const en = JSON.parse(JSON.stringify(translationsEn));

  inputs.forEach(input => {
    const path = input.getAttribute('data-trans-path');
    const lang = input.getAttribute('data-trans-lang');
    const value = input.value;
    setNestedValue(lang === 'sl' ? sl : en, path, value);
  });

  const slChanged = JSON.stringify(sl) !== JSON.stringify(translationsSl);
  const enChanged = JSON.stringify(en) !== JSON.stringify(translationsEn);

  const promises = [];
  if (slChanged) promises.push(apiPut('messages-sl', sl, translationsSlSha).then(r => { translationsSl = sl; translationsSlSha = r.sha; }));
  if (enChanged) promises.push(apiPut('messages-en', en, translationsEnSha).then(r => { translationsEn = en; translationsEnSha = r.sha; }));

  if (promises.length > 0) await Promise.all(promises);
}

// ---- Translation API (MyMemory SL→EN) ----
async function translateText(text) {
  if (!text || !text.trim()) return '';
  const MAX_CHUNK = 480;
  async function fetchTranslation(chunk) {
    const res = await fetch('https://api.mymemory.translated.net/get?q=' + encodeURIComponent(chunk.trim()) + '&langpair=sl|en');
    const data = await res.json();
    if (data.responseData && data.responseData.translatedText) {
      return data.responseData.translatedText;
    }
    throw new Error('Prevod ni uspel');
  }
  if (text.length <= MAX_CHUNK) return fetchTranslation(text);
  // Split long text into sentences and batch
  const sentences = text.match(/[^.!?]+[.!?]+[\s]*/g) || [text];
  let chunks = [], current = '';
  for (const s of sentences) {
    if ((current + s).length > MAX_CHUNK && current) { chunks.push(current); current = s; }
    else { current += s; }
  }
  if (current) chunks.push(current);
  let result = '';
  for (const chunk of chunks) {
    try { result += await fetchTranslation(chunk) + ' '; } catch { result += chunk + ' '; }
    await new Promise(r => setTimeout(r, 200));
  }
  return result.trim();
}

async function translateField(btn) {
  const grid = btn.closest('[style*="grid"]') || btn.closest('.trans-row');
  if (!grid) return;
  const slInput = grid.querySelector('[data-trans-lang="sl"]');
  const enInput = grid.querySelector('[data-trans-lang="en"]');
  if (!slInput || !enInput) return;
  const text = slInput.value.trim();
  if (!text) { showToast('SL polje je prazno', 'error'); return; }
  btn.disabled = true;
  const orig = btn.textContent;
  btn.textContent = '...';
  try {
    enInput.value = await translateText(text);
    showToast('Prevedeno!');
  } catch (e) {
    showToast('Napaka pri prevajanju', 'error');
  }
  btn.disabled = false;
  btn.textContent = orig;
}

async function translateAllToEN() {
  const section = document.querySelector('.section-content.active');
  if (!section) return;
  const slInputs = section.querySelectorAll('[data-trans-lang="sl"]');
  if (slInputs.length === 0) { showToast('Ni besedil za prevajanje', 'error'); return; }
  const toTranslate = [];
  slInputs.forEach(sl => {
    const text = sl.value.trim();
    if (!text) return;
    const path = sl.getAttribute('data-trans-path');
    const en = section.querySelector('[data-trans-path="' + path + '"][data-trans-lang="en"]');
    if (en) toTranslate.push({ text, en });
  });
  if (toTranslate.length === 0) { showToast('Ni besedil za prevajanje', 'error'); return; }
  showToast('Prevajam ' + toTranslate.length + ' besedil...');
  let count = 0, errors = 0;
  for (const item of toTranslate) {
    try { item.en.value = await translateText(item.text); count++; }
    catch { errors++; }
    await new Promise(r => setTimeout(r, 300));
  }
  showToast('Prevedeno ' + count + '/' + toTranslate.length + (errors ? ' (' + errors + ' napak)' : ''));
}

// ---- Auth ----
async function doLogin() {
  const pw = val('login-pw');
  const errEl = document.getElementById('login-error');
  errEl.textContent = '';
  if (!pw) { errEl.textContent = 'Vnesite geslo.'; return; }
  try {
    const r = await fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pw })
    });
    const d = await r.json();
    if (!r.ok || !d.token) { errEl.textContent = d.error || 'Napačno geslo.'; return; }
    sessionStorage.setItem('admin_token', d.token);
    showApp();
  } catch (e) {
    errEl.textContent = 'Napaka pri povezavi.';
  }
}

function doLogout() {
  sessionStorage.removeItem('admin_token');
  location.reload();
}

async function showApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  buildSidebar();
  // Auto-load translations on login
  await loadTranslationsData();
  switchSection('hero');
}

// ---- API ----
async function apiGet(fileKey) {
  const r = await fetch('/api/content?file=' + encodeURIComponent(fileKey), {
    headers: { 'Authorization': 'Bearer ' + getToken() }
  });
  if (r.status === 401) { doLogout(); throw new Error('Unauthorized'); }
  if (!r.ok) throw new Error('API error ' + r.status);
  return r.json();
}

async function apiPut(fileKey, data, sha) {
  const r = await fetch('/api/content?file=' + encodeURIComponent(fileKey), {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getToken() },
    body: JSON.stringify({ data, sha })
  });
  if (r.status === 401) { doLogout(); throw new Error('Unauthorized'); }
  const d = await r.json();
  if (!r.ok || !d.success) throw new Error(d.error || 'Save failed');
  return d;
}

// ---- Cloudinary Upload ----
function uploadImage() {
  return new Promise((resolve, reject) => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*,video/*';
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 10 * 1024 * 1024) {
        showToast('Datoteka je prevelika (max 10 MB)', 'error');
        return;
      }
      showToast('Nalagam...');
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', CLOUDINARY_PRESET);
      try {
        const res = await fetch('https://api.cloudinary.com/v1_1/' + CLOUDINARY_CLOUD + '/auto/upload', {
          method: 'POST', body: fd
        });
        const data = await res.json();
        if (data.secure_url) {
          showToast('Naloženo!');
          resolve(data.secure_url);
        } else {
          showToast('Napaka pri nalaganju', 'error');
          reject(new Error('Upload failed'));
        }
      } catch (err) {
        showToast('Napaka pri nalaganju', 'error');
        reject(err);
      }
    };
    input.click();
  });
}

// ---- Sidebar ----
function buildSidebar() {
  const nav = document.getElementById('sidebar-nav');
  nav.innerHTML = SECTIONS.map(s =>
    '<button data-key="' + s.key + '" onclick="switchSection(\'' + s.key + '\')">' + esc(s.label) + '</button>'
  ).join('');
}

function switchSection(key) {
  currentSection = key;
  document.querySelectorAll('.sidebar-nav button').forEach(b => {
    b.classList.toggle('active', b.dataset.key === key);
  });
  document.querySelectorAll('.section-content').forEach(el => {
    el.classList.toggle('active', el.id === 'section-' + key);
  });
  loadSection(key);
}

async function loadSection(key) {
  const sec = SECTIONS.find(s => s.key === key);
  if (!sec) return;

  if (key === 'translations') {
    renderTranslations();
    return;
  }

  if (sectionData[key]) {
    renderSection(key);
    return;
  }

  const el = document.getElementById('section-' + key);
  el.innerHTML = '<p style="color:var(--muted)">Nalagam...</p>';

  try {
    const res = await apiGet(sec.file);
    sectionData[key] = { data: res.data || {}, sha: res.sha };
    renderSection(key);
  } catch (e) {
    el.innerHTML = '<p style="color:var(--danger)">Napaka: ' + esc(e.message) + '</p>';
  }
}

function renderSection(key) {
  const renderers = {
    hero: renderHero,
    about: renderAbout,
    encounters: renderEncounters,
    gallery: renderGallery,
    music: renderMusic,
    studio: renderStudio,
    collections: renderCollections,
    biography: renderBiography,
    contact: renderContact,
  };
  if (renderers[key]) renderers[key]();
}

async function saveSection(fileKey, collectFn) {
  const sec = SECTIONS.find(s => s.file === fileKey);
  const sKey = sec ? sec.key : fileKey;
  try {
    const data = collectFn();
    const sha = sectionData[sKey]?.sha || '';
    const res = await apiPut(fileKey, data, sha);
    sectionData[sKey].sha = res.sha;
    sectionData[sKey].data = data;
    await saveInlineTranslations();
    showToast('Shranjeno!');
  } catch (e) {
    showToast('Napaka: ' + e.message, 'error');
  }
}

// ---- Load translations data (called on login) ----
async function loadTranslationsData() {
  if (translationsSl && translationsEn) return;
  try {
    const [slRes, enRes] = await Promise.all([
      apiGet('messages-sl'),
      apiGet('messages-en')
    ]);
    translationsSl = slRes.data || {};
    translationsEn = enRes.data || {};
    translationsSlSha = slRes.sha;
    translationsEnSha = enRes.sha;
  } catch (e) {
    console.error('Napaka pri nalaganju prevodov:', e);
  }
}

/* =========================================================
   SECTION RENDERERS
   ========================================================= */

// ---- 1. HERO ----
function renderHero() {
  const d = sectionData.hero.data;
  document.getElementById('section-hero').innerHTML = `
    <h1>Junak</h1>
    <div class="save-bar">
      <button class="btn btn-accent" onclick="saveSection('hero', collectHeroData)">Shrani</button>
      <button class="btn btn-outline btn-sm" onclick="translateAllToEN()">Prevedi vse v EN</button>
      <button class="btn btn-history btn-sm" onclick="showHistory('hero')">&#x1F552; Zgodovina</button>
    </div>
    <div class="card">
      <div class="field">
        <label for="hero-videoUrl">Povezava videa</label>
        <input type="text" id="hero-videoUrl" value="${esc(d.videoUrl || '')}" placeholder="https://res.cloudinary.com/...">
      </div>
    </div>
    <div class="card">
      <h3 style="margin-bottom:16px">Besedila</h3>
      ${renderTransPair('Vloge', 'hero.roles')}
      ${renderTransPair('Citat', 'hero.quote')}
      ${renderTransPair('Avtor citata', 'hero.quoteAuthor')}
      ${renderTransPair('Poslušaj glasbo (gumb)', 'hero.listenMusic')}
      ${renderTransPair('Spoznaj Filipa (gumb)', 'hero.meetFilip')}
    </div>
  `;
}

function collectHeroData() {
  return { videoUrl: val('hero-videoUrl') };
}

// ---- 2. ABOUT ----
function renderAbout() {
  const d = sectionData.about.data;
  const stats = d.stats || [];
  const abilityKeys = d.abilityKeys || [];

  let statsHtml = '';
  stats.forEach((s, i) => {
    statsHtml += `
      <div class="list-item" data-stat-idx="${i}">
        <div class="list-fields">
          <div class="field">
            <label>Številka</label>
            <input type="number" class="stat-number" value="${esc(s.number || '')}" placeholder="3000">
          </div>
          <div class="field">
            <label>Pripona</label>
            <input type="text" class="stat-suffix" value="${esc(s.suffix || '')}" placeholder="+">
          </div>
          <div class="field">
            <label>Ključ</label>
            <input type="text" class="stat-key" value="${esc(s.key || '')}" placeholder="songs">
          </div>
          ${s.key ? renderTransPair('Oznaka statistike', 'about.stats.' + s.key + '.label') : ''}
          ${s.key ? renderTransPair('Opis statistike', 'about.stats.' + s.key + '.description') : ''}
        </div>
        <button class="btn btn-danger btn-sm" onclick="removeStatItem(${i})">&#x2715;</button>
      </div>
    `;
  });

  let abilityKeysHtml = '';
  (abilityKeys).forEach((k, i) => {
    abilityKeysHtml += `
      <div class="list-item" data-ability-idx="${i}">
        <div class="list-fields">
          <div class="field">
            <label>Ključ sposobnosti</label>
            <input type="text" class="ability-key" value="${esc(k)}" placeholder="absolutePitch">
          </div>
          ${k ? renderTransPair('Naslov sposobnosti', 'about.abilities.' + k + '.title') : ''}
          ${k ? renderTransPair('Opis sposobnosti', 'about.abilities.' + k + '.description') : ''}
        </div>
        <button class="btn btn-danger btn-sm" onclick="removeAbilityKey(${i})">&#x2715;</button>
      </div>
    `;
  });

  document.getElementById('section-about').innerHTML = `
    <h1>O Filipu</h1>
    <div class="save-bar">
      <button class="btn btn-accent" onclick="saveSection('about', collectAboutData)">Shrani</button>
      <button class="btn btn-outline btn-sm" onclick="translateAllToEN()">Prevedi vse v EN</button>
      <button class="btn btn-history btn-sm" onclick="showHistory('about')">&#x1F552; Zgodovina</button>
    </div>

    <div class="card">
      <h3 style="margin-bottom:16px">Besedila</h3>
      ${renderTransPair('Nadnaslov', 'about.supra')}
      ${renderTransPair('Naslov', 'about.heading')}
      ${renderTransPair('Zgodba', 'about.story', {textarea:true})}
      ${renderTransPair('Citat', 'about.blockquote')}
      ${renderTransPair('Gumb za celotno zgodbo', 'about.readFullStory')}
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Ključi sposobnosti</h3>
        <button class="btn btn-outline btn-sm" onclick="addAbilityKey()">+ Dodaj</button>
      </div>
      <div id="ability-keys-list">${abilityKeysHtml}</div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Statistika</h3>
        <button class="btn btn-outline btn-sm" onclick="addStatItem()">+ Dodaj</button>
      </div>
      <div id="stats-list">${statsHtml}</div>
    </div>
  `;
}

function collectAboutData() {
  const stats = [];
  document.querySelectorAll('#stats-list .list-item').forEach(el => {
    stats.push({
      number: parseInt(el.querySelector('.stat-number').value) || 0,
      suffix: el.querySelector('.stat-suffix').value,
      key: el.querySelector('.stat-key').value,
    });
  });
  const abilityKeys = [];
  document.querySelectorAll('#ability-keys-list .list-item').forEach(el => {
    const v = el.querySelector('.ability-key').value.trim();
    if (v) abilityKeys.push(v);
  });
  return { abilityKeys, stats };
}

function addStatItem() {
  const d = sectionData.about.data;
  d.stats = d.stats || [];
  d.stats.push({ number: 0, suffix: '', key: '' });
  renderAbout();
}

function removeStatItem(i) {
  sectionData.about.data.stats.splice(i, 1);
  renderAbout();
}

function addAbilityKey() {
  const d = sectionData.about.data;
  d.abilityKeys = d.abilityKeys || [];
  d.abilityKeys.push('');
  renderAbout();
}

function removeAbilityKey(i) {
  sectionData.about.data.abilityKeys.splice(i, 1);
  renderAbout();
}

// ---- 3. ENCOUNTERS ----
function renderEncounters() {
  const d = sectionData.encounters.data;
  const featured = d.featured || [];
  const all = d.all || [];
  const images = d.images || {};
  const videos = d.videos || {};
  const highlightKeys = d.highlightKeys || [];

  let sectionTextsHtml = `
    <div class="card">
      <h3 style="margin-bottom:16px">Besedila sekcije</h3>
      ${renderTransPair('Nadnaslov', 'encounters.supra')}
      ${renderTransPair('Naslov', 'encounters.heading')}
      ${renderTransPair('Podnaslov', 'encounters.subtitle')}
    </div>
  `;

  let allHtml = '';
  all.forEach((key, i) => {
    const img = images[key] || '';
    const vid = videos[key] || '';
    const isFeatured = featured.includes(key);
    const isHighlight = highlightKeys.includes(key);
    allHtml += `
      <div class="card${i===0 && key==='new_encounter' ? ' card-new' : ''}" data-enc-idx="${i}">
        <div class="card-header">
          <h3>#${i+1}: <span class="enc-key-display">${esc(key)}</span></h3>
          <div style="display:flex;gap:4px;align-items:center">
            <button class="btn-move" onclick="moveEncounter(${i},${i-1})" ${i===0?'disabled':''} title="Gor">&#x25B2;</button>
            <button class="btn-move" onclick="moveEncounter(${i},${i+1})" ${i===all.length-1?'disabled':''} title="Dol">&#x25BC;</button>
            <button class="btn btn-danger btn-sm" onclick="removeEncounter(${i})">&#x2715; Odstrani</button>
          </div>
        </div>
        <div class="field">
          <label>Ključ</label>
          <input type="text" class="enc-key" value="${esc(key)}" placeholder="plestenjak">
        </div>
        <div class="check-list">
          <label class="check-item">
            <input type="checkbox" class="enc-featured" ${isFeatured ? 'checked' : ''}> Na glavni strani
          </label>
          <label class="check-item">
            <input type="checkbox" class="enc-highlight" ${isHighlight ? 'checked' : ''}> Rdeč poudarek
          </label>
        </div>
        <div class="field">
          <label>Povezava slike</label>
          <div class="img-row">
            ${img ? '<img src="'+esc(img)+'" class="img-preview img-preview-lg" onerror="this.style.display=\'none\'">' : ''}
            <input type="text" class="enc-image" value="${esc(img)}" placeholder="https://...">
            <button class="btn btn-outline btn-sm" onclick="uploadForInput(this, 'enc-image')">Naloži</button>
          </div>
        </div>
        <div class="field">
          <label>Povezava videa (neobvezno)</label>
          <div class="img-row">
            <input type="text" class="enc-video" value="${esc(vid)}" placeholder="https://...">
            <button class="btn btn-outline btn-sm" onclick="uploadForInput(this, 'enc-video')">Naloži</button>
          </div>
        </div>
        <div class="trans-pair-group">
          <h4>Besedila (SL / EN)</h4>
          ${renderTransPair('Ime', 'encounters.items.' + key + '.name')}
          ${renderTransPair('Vloga', 'encounters.items.' + key + '.role')}
          ${renderTransPair('Dogodek', 'encounters.items.' + key + '.event')}
          ${renderTransPair('Opis', 'encounters.items.' + key + '.description')}
          ${renderTransPair('Celotna zgodba', 'encounters.items.' + key + '.fullStory', {textarea:true})}
        </div>
      </div>
    `;
  });

  document.getElementById('section-encounters').innerHTML = `
    <h1>Srečanja — ${all.length}</h1>
    <div class="save-bar">
      <button class="btn btn-accent" onclick="saveSection('encounters', collectEncountersData)">Shrani</button>
      <button class="btn btn-outline btn-sm" onclick="addEncounter()">+ Dodaj srečanje</button>
      <button class="btn btn-outline btn-sm" onclick="translateAllToEN()">Prevedi vse v EN</button>
      <button class="btn btn-history btn-sm" onclick="showHistory('encounters')">&#x1F552; Zgodovina</button>
    </div>
    ${sectionTextsHtml}
    <div id="encounters-list">${allHtml}</div>
  `;
}

function collectEncountersData() {
  const all = [];
  const featured = [];
  const images = {};
  const videos = {};
  const highlightKeys = [];

  document.querySelectorAll('#encounters-list .card').forEach(el => {
    const key = el.querySelector('.enc-key').value.trim();
    if (!key) return;
    all.push(key);
    if (el.querySelector('.enc-featured').checked) featured.push(key);
    if (el.querySelector('.enc-highlight').checked) highlightKeys.push(key);
    const img = el.querySelector('.enc-image').value.trim();
    const vid = el.querySelector('.enc-video').value.trim();
    if (img) images[key] = img;
    if (vid) videos[key] = vid;
  });
  return { featured, all, images, videos, highlightKeys };
}

function addEncounter() {
  const d = sectionData.encounters.data;
  d.all = d.all || [];
  d.all.unshift('new_encounter');
  d.images = d.images || {};
  d.videos = d.videos || {};
  renderEncounters();
  scrollToNew('encounters-list');
}

function removeEncounter(i) {
  const d = sectionData.encounters.data;
  const key = d.all[i];
  d.all.splice(i, 1);
  if (d.featured) d.featured = d.featured.filter(k => k !== key);
  if (d.highlightKeys) d.highlightKeys = d.highlightKeys.filter(k => k !== key);
  if (d.images) delete d.images[key];
  if (d.videos) delete d.videos[key];
  renderEncounters();
}

function moveEncounter(from, to) {
  const d = sectionData.encounters.data;
  moveItem(d.all, from, to);
  renderEncounters();
}

// ---- 4. GALLERY ----
function renderGallery() {
  const d = sectionData.gallery.data;
  const featured = d.featured || [];
  const all = d.all || [];
  const images = d.images || {};
  const positions = d.positions || {};

  let sectionTextsHtml = `
    <div class="card">
      <h3 style="margin-bottom:16px">Besedila sekcije</h3>
      ${renderTransPair('Nadnaslov', 'gallery.supra')}
      ${renderTransPair('Naslov', 'gallery.heading')}
    </div>
  `;

  let allHtml = '';
  all.forEach((key, i) => {
    const img = images[key] || '';
    const pos = positions[key] || '';
    const isFeatured = featured.includes(key);
    allHtml += `
      <div class="card${i===0 && key==='new_photo' ? ' card-new' : ''}" data-gal-idx="${i}">
        <div class="card-header">
          <h3>#${i+1}: ${esc(key)}</h3>
          <div style="display:flex;gap:4px;align-items:center">
            <button class="btn-move" onclick="moveGalleryItem(${i},${i-1})" ${i===0?'disabled':''} title="Gor">&#x25B2;</button>
            <button class="btn-move" onclick="moveGalleryItem(${i},${i+1})" ${i===all.length-1?'disabled':''} title="Dol">&#x25BC;</button>
            <button class="btn btn-danger btn-sm" onclick="removeGalleryItem(${i})">&#x2715;</button>
          </div>
        </div>
        <div class="field">
          <label>Ključ</label>
          <input type="text" class="gal-key" value="${esc(key)}">
        </div>
        <label class="check-item" style="margin-bottom:12px">
          <input type="checkbox" class="gal-featured" ${isFeatured ? 'checked' : ''}> Na glavni strani
        </label>
        <div class="field">
          <label>Povezava slike</label>
          <div class="img-row">
            ${img ? '<img src="'+esc(img)+'" class="img-preview" onerror="this.style.display=\'none\'">' : ''}
            <input type="text" class="gal-image" value="${esc(img)}">
            <button class="btn btn-outline btn-sm" onclick="uploadForInput(this, 'gal-image')">Naloži</button>
          </div>
        </div>
        <div class="field">
          <label>Pozicija slike (neobvezno)</label>
          <input type="text" class="gal-position" value="${esc(pos)}" placeholder="center top">
        </div>
        <div class="trans-pair-group">
          <h4>Besedila (SL / EN)</h4>
          ${renderTransPair('Alt besedilo', 'gallery.photos.' + key + '.alt')}
          ${renderTransPair('Podnapis', 'gallery.photos.' + key + '.caption')}
        </div>
      </div>
    `;
  });

  document.getElementById('section-gallery').innerHTML = `
    <h1>Galerija — ${all.length} fotografij</h1>
    <div class="save-bar">
      <button class="btn btn-accent" onclick="saveSection('gallery', collectGalleryData)">Shrani</button>
      <button class="btn btn-outline btn-sm" onclick="addGalleryItem()">+ Dodaj fotografijo</button>
      <button class="btn btn-outline btn-sm" onclick="translateAllToEN()">Prevedi vse v EN</button>
      <button class="btn btn-history btn-sm" onclick="showHistory('gallery')">&#x1F552; Zgodovina</button>
    </div>
    ${sectionTextsHtml}
    <div id="gallery-list">${allHtml}</div>
  `;
}

function collectGalleryData() {
  const all = [];
  const featured = [];
  const images = {};
  const positions = {};

  document.querySelectorAll('#gallery-list .card').forEach(el => {
    const key = el.querySelector('.gal-key').value.trim();
    if (!key) return;
    all.push(key);
    if (el.querySelector('.gal-featured').checked) featured.push(key);
    const img = el.querySelector('.gal-image').value.trim();
    const pos = el.querySelector('.gal-position').value.trim();
    if (img) images[key] = img;
    if (pos) positions[key] = pos;
  });
  return { featured, all, images, positions };
}

function addGalleryItem() {
  const d = sectionData.gallery.data;
  d.all = d.all || [];
  d.all.unshift('new_photo');
  renderGallery();
  scrollToNew('gallery-list');
}

function removeGalleryItem(i) {
  const d = sectionData.gallery.data;
  const key = d.all[i];
  d.all.splice(i, 1);
  if (d.featured) d.featured = d.featured.filter(k => k !== key);
  if (d.images) delete d.images[key];
  if (d.positions) delete d.positions[key];
  renderGallery();
}

function moveGalleryItem(from, to) {
  const d = sectionData.gallery.data;
  moveItem(d.all, from, to);
  renderGallery();
}

// ---- 5. MUSIC ----
function renderMusic() {
  const d = sectionData.music.data;
  const featuredId = d.featuredId || '';
  const featured = d.featured || [];
  const all = d.all || [];
  const videoIds = d.videoIds || {};

  let sectionTextsHtml = `
    <div class="card">
      <h3 style="margin-bottom:16px">Besedila sekcije</h3>
      ${renderTransPair('Nadnaslov', 'music.supra')}
      ${renderTransPair('Naslov', 'music.heading')}
      ${renderTransPair('Podnaslov', 'music.subtitle')}
    </div>
  `;

  let allHtml = '';
  all.forEach((key, i) => {
    const vid = videoIds[key] || '';
    const isFeatured = featured.includes(key);
    allHtml += `
      <div class="card${i===0 && key==='new_video' ? ' card-new' : ''}" data-mus-idx="${i}">
        <div class="card-header">
          <h3>#${i+1}: ${esc(key)}</h3>
          <div style="display:flex;gap:4px;align-items:center">
            <button class="btn-move" onclick="moveMusicItem(${i},${i-1})" ${i===0?'disabled':''} title="Gor">&#x25B2;</button>
            <button class="btn-move" onclick="moveMusicItem(${i},${i+1})" ${i===all.length-1?'disabled':''} title="Dol">&#x25BC;</button>
            <button class="btn btn-danger btn-sm" onclick="removeMusicItem(${i})">&#x2715;</button>
          </div>
        </div>
        <div class="field">
          <label>Ključ</label>
          <input type="text" class="mus-key" value="${esc(key)}">
        </div>
        <label class="check-item" style="margin-bottom:12px">
          <input type="checkbox" class="mus-featured" ${isFeatured ? 'checked' : ''}> Na glavni strani
        </label>
        <div class="field">
          <label>YouTube ID</label>
          <input type="text" class="mus-videoid" value="${esc(vid)}" placeholder="dQw4w9WgXcQ">
        </div>
        <div class="trans-pair-group">
          <h4>Besedila (SL / EN)</h4>
          ${renderTransPair('Naslov', 'music.videos.' + key + '.title')}
          ${renderTransPair('Opis', 'music.videos.' + key + '.description')}
        </div>
      </div>
    `;
  });

  document.getElementById('section-music').innerHTML = `
    <h1>Glasba — ${all.length} videov</h1>
    <div class="save-bar">
      <button class="btn btn-accent" onclick="saveSection('music', collectMusicData)">Shrani</button>
      <button class="btn btn-outline btn-sm" onclick="addMusicItem()">+ Dodaj video</button>
      <button class="btn btn-outline btn-sm" onclick="translateAllToEN()">Prevedi vse v EN</button>
      <button class="btn btn-history btn-sm" onclick="showHistory('music')">&#x1F552; Zgodovina</button>
    </div>
    ${sectionTextsHtml}
    <div class="card">
      <div class="field">
        <label for="music-featuredId">ID izpostavljenega videa (YouTube)</label>
        <input type="text" id="music-featuredId" value="${esc(featuredId)}" placeholder="dQw4w9WgXcQ">
      </div>
    </div>
    <div id="music-list">${allHtml}</div>
  `;
}

function collectMusicData() {
  const all = [];
  const featured = [];
  const videoIds = {};

  document.querySelectorAll('#music-list .card').forEach(el => {
    const key = el.querySelector('.mus-key').value.trim();
    if (!key) return;
    all.push(key);
    if (el.querySelector('.mus-featured').checked) featured.push(key);
    const vid = el.querySelector('.mus-videoid').value.trim();
    if (vid) videoIds[key] = vid;
  });
  return { featuredId: val('music-featuredId'), featured, all, videoIds };
}

function addMusicItem() {
  const d = sectionData.music.data;
  d.all = d.all || [];
  d.all.unshift('new_video');
  renderMusic();
  scrollToNew('music-list');
}

function removeMusicItem(i) {
  const d = sectionData.music.data;
  const key = d.all[i];
  d.all.splice(i, 1);
  if (d.featured) d.featured = d.featured.filter(k => k !== key);
  if (d.videoIds) delete d.videoIds[key];
  renderMusic();
}

function moveMusicItem(from, to) {
  const d = sectionData.music.data;
  moveItem(d.all, from, to);
  renderMusic();
}

// ---- 6. STUDIO ----
function renderStudio() {
  const d = sectionData.studio.data;
  const albums = d.albums || [];

  let sectionTextsHtml = `
    <div class="card">
      <h3 style="margin-bottom:16px">Besedila sekcije</h3>
      ${renderTransPair('Nadnaslov', 'studio.supra')}
      ${renderTransPair('Naslov', 'studio.heading')}
      ${renderTransPair('Podnaslov', 'studio.subtitle', {textarea:true})}
      ${renderTransPair('Zgodba 1', 'studio.storyP1', {textarea:true})}
      ${renderTransPair('Zgodba 2', 'studio.storyP2', {textarea:true})}
      ${renderTransPair('Zgodba 3', 'studio.storyP3', {textarea:true})}
      ${renderTransPair('Naslov albumov', 'studio.albumsHeading')}
      ${renderTransPair('Podnaslov albumov', 'studio.albumsSubtitle')}
    </div>
  `;

  let albumsHtml = '';
  albums.forEach((album, ai) => {
    let imagesHtml = '';
    (album.images || []).forEach((img, ii) => {
      imagesHtml += `
        <div class="img-row" data-album-img="${ai}-${ii}">
          <img src="${esc(img)}" class="img-preview img-preview-sm" onerror="this.style.display='none'">
          <input type="text" class="studio-album-img" value="${esc(img)}" style="flex:1">
          <button class="btn btn-outline btn-sm" onclick="uploadForInput(this, 'studio-album-img')">Naloži</button>
          <button class="btn btn-danger btn-sm" onclick="removeStudioAlbumImage(${ai}, ${ii})">&#x2715;</button>
        </div>
      `;
    });

    albumsHtml += `
      <div class="card" data-album-idx="${ai}">
        <div class="card-header">
          <h3>Album #${ai+1}</h3>
          <button class="btn btn-danger btn-sm" onclick="removeStudioAlbum(${ai})">&#x2715; Odstrani album</button>
        </div>
        <div class="field">
          <label>Ključ</label>
          <input type="text" class="album-key" value="${esc(album.key || '')}">
        </div>
        <div class="field">
          <label>Povezava naslovnice</label>
          <div class="img-row">
            ${album.cover ? '<img src="'+esc(album.cover)+'" class="img-preview" onerror="this.style.display=\'none\'">' : ''}
            <input type="text" class="album-cover" value="${esc(album.cover || '')}">
            <button class="btn btn-outline btn-sm" onclick="uploadForInput(this, 'album-cover')">Naloži</button>
          </div>
        </div>
        <div class="field">
          <label>Slike albuma</label>
          <div class="album-images" id="album-images-${ai}">${imagesHtml}</div>
          <button class="btn btn-outline btn-sm" style="margin-top:8px" onclick="addStudioAlbumImage(${ai})">+ Dodaj sliko</button>
        </div>
        <div class="trans-pair-group">
          <h4>Besedila (SL / EN)</h4>
          ${renderTransPair('Ime albuma', 'studio.album' + (ai+1))}
        </div>
      </div>
    `;
  });

  document.getElementById('section-studio').innerHTML = `
    <h1>V studiu — ${albums.length} albumi</h1>
    <div class="save-bar">
      <button class="btn btn-accent" onclick="saveSection('studio', collectStudioData)">Shrani</button>
      <button class="btn btn-outline btn-sm" onclick="addStudioAlbum()">+ Dodaj album</button>
      <button class="btn btn-outline btn-sm" onclick="translateAllToEN()">Prevedi vse v EN</button>
      <button class="btn btn-history btn-sm" onclick="showHistory('studio')">&#x1F552; Zgodovina</button>
    </div>
    ${sectionTextsHtml}
    <div id="studio-albums-list">${albumsHtml}</div>
  `;
}

function collectStudioData() {
  const albums = [];
  document.querySelectorAll('#studio-albums-list .card').forEach(el => {
    const key = el.querySelector('.album-key').value.trim();
    const cover = el.querySelector('.album-cover').value.trim();
    const images = [];
    el.querySelectorAll('.studio-album-img').forEach(inp => {
      const v = inp.value.trim();
      if (v) images.push(v);
    });
    albums.push({ key, cover, images });
  });
  return { albums };
}

function addStudioAlbum() {
  const d = sectionData.studio.data;
  d.albums = d.albums || [];
  d.albums.push({ key: '', cover: '', images: [] });
  renderStudio();
}

function removeStudioAlbum(i) {
  sectionData.studio.data.albums.splice(i, 1);
  renderStudio();
}

function addStudioAlbumImage(ai) {
  const d = sectionData.studio.data;
  d.albums[ai].images = d.albums[ai].images || [];
  d.albums[ai].images.push('');
  renderStudio();
}

function removeStudioAlbumImage(ai, ii) {
  sectionData.studio.data.albums[ai].images.splice(ii, 1);
  renderStudio();
}

// ---- 7. COLLECTIONS ----
function renderCollections() {
  const d = sectionData.collections.data;
  const kb = d.keyboards || { images: [], items: [] };
  const dc = d.dictaphones || { images: [], items: [] };

  let sectionTextsHtml = `
    <div class="card">
      <h3 style="margin-bottom:16px">Besedila sekcije</h3>
      ${renderTransPair('Nadnaslov', 'collections.supra')}
      ${renderTransPair('Naslov', 'collections.heading')}
      ${renderTransPair('Podnaslov', 'collections.subtitle', {textarea:true})}
    </div>
  `;

  function renderCategory(cat, prefix, data) {
    let imagesHtml = '';
    (data.images || []).forEach((img, i) => {
      imagesHtml += `
        <div class="img-row" data-col-img="${prefix}-${i}">
          <img src="${esc(img)}" class="img-preview img-preview-sm" onerror="this.style.display='none'">
          <input type="text" class="col-${prefix}-img" value="${esc(img)}" style="flex:1">
          <button class="btn btn-outline btn-sm" onclick="uploadForInput(this, 'col-${prefix}-img')">Naloži</button>
          <button class="btn btn-danger btn-sm" onclick="removeCollectionImage('${prefix}', ${i})">&#x2715;</button>
        </div>
      `;
    });

    let itemsHtml = '';
    (data.items || []).forEach((item, i) => {
      itemsHtml += `
        <div class="list-item" data-col-item="${prefix}-${i}">
          <div class="list-fields">
            <input type="text" class="col-${prefix}-item" value="${esc(item)}" placeholder="yamaha">
            ${item ? renderTransPair('Ime naprave', 'collections.items.' + item + '.name') : ''}
            ${item ? renderTransPair('Opis naprave', 'collections.items.' + item + '.description') : ''}
          </div>
          <button class="btn btn-danger btn-sm" onclick="removeCollectionItem('${prefix}', ${i})">&#x2715;</button>
        </div>
      `;
    });

    return `
      <div class="card">
        <div class="card-header">
          <h3>${esc(cat)}</h3>
        </div>
        <div class="field">
          <label>Slike</label>
          <div id="col-${prefix}-images">${imagesHtml}</div>
          <button class="btn btn-outline btn-sm" style="margin-top:8px" onclick="addCollectionImage('${prefix}')">+ Dodaj sliko</button>
        </div>
        <div class="field" style="margin-top:16px">
          <label>Predmeti (ključi)</label>
          <div id="col-${prefix}-items">${itemsHtml}</div>
          <button class="btn btn-outline btn-sm" style="margin-top:8px" onclick="addCollectionItem('${prefix}')">+ Dodaj predmet</button>
        </div>
      </div>
    `;
  }

  document.getElementById('section-collections').innerHTML = `
    <h1>Zbirke</h1>
    <div class="save-bar">
      <button class="btn btn-accent" onclick="saveSection('collections', collectCollectionsData)">Shrani</button>
      <button class="btn btn-outline btn-sm" onclick="translateAllToEN()">Prevedi vse v EN</button>
      <button class="btn btn-history btn-sm" onclick="showHistory('collections')">&#x1F552; Zgodovina</button>
    </div>
    ${sectionTextsHtml}
    ${renderCategory('Klaviature', 'keyboards', kb)}
    ${renderCategory('Diktafoni', 'dictaphones', dc)}
  `;
}

function collectCollectionsData() {
  function collectCat(prefix) {
    const images = [];
    document.querySelectorAll('.col-' + prefix + '-img').forEach(inp => {
      const v = inp.value.trim();
      if (v) images.push(v);
    });
    const items = [];
    document.querySelectorAll('.col-' + prefix + '-item').forEach(inp => {
      const v = inp.value.trim();
      if (v) items.push(v);
    });
    return { images, items };
  }
  return {
    keyboards: collectCat('keyboards'),
    dictaphones: collectCat('dictaphones'),
  };
}

function addCollectionImage(prefix) {
  const d = sectionData.collections.data;
  const cat = prefix === 'keyboards' ? 'keyboards' : 'dictaphones';
  d[cat] = d[cat] || { images: [], items: [] };
  d[cat].images = d[cat].images || [];
  d[cat].images.push('');
  renderCollections();
}

function removeCollectionImage(prefix, i) {
  const cat = prefix === 'keyboards' ? 'keyboards' : 'dictaphones';
  sectionData.collections.data[cat].images.splice(i, 1);
  renderCollections();
}

function addCollectionItem(prefix) {
  const d = sectionData.collections.data;
  const cat = prefix === 'keyboards' ? 'keyboards' : 'dictaphones';
  d[cat] = d[cat] || { images: [], items: [] };
  d[cat].items = d[cat].items || [];
  d[cat].items.push('');
  renderCollections();
}

function removeCollectionItem(prefix, i) {
  const cat = prefix === 'keyboards' ? 'keyboards' : 'dictaphones';
  sectionData.collections.data[cat].items.splice(i, 1);
  renderCollections();
}

// ---- 8. BIOGRAPHY ----
function renderBiography() {
  const d = sectionData.biography.data;
  const chapters = [
    { key: 'birthPhotos',          label: 'Rojstvo' },
    { key: 'firstMonthsPhotos',    label: 'Prvi meseci' },
    { key: 'singingWithMomPhotos', label: 'Petje z mamo' },
    { key: 'fatherPhotos',         label: 'Oče' },
    { key: 'musicalTalentPhotos',  label: 'Glasbeni talent' },
    { key: 'autisticPhotos',       label: 'Avtistične lastnosti' },
    { key: 'careerPhotos',         label: 'Kariera' },
    { key: 'motherPhotos',         label: 'Mama' },
    { key: 'endPhoto',             label: 'Zaključek' },
  ];

  const chapterTexts = {
    birthPhotos: ['ch1title', 'ch1p1', 'ch1p2', 'ch1q'],
    firstMonthsPhotos: ['ch2title', 'ch2p1'],
    singingWithMomPhotos: ['ch3title', 'ch3p1', 'ch3q'],
    fatherPhotos: ['ch4title', 'ch4p1'],
    musicalTalentPhotos: ['ch5title', 'ch5p1', 'ch5q', 'ch5p2'],
    autisticPhotos: ['ch6title', 'ch6p1', 'ch6q', 'ch6p2'],
    careerPhotos: ['ch7title', 'ch7p1'],
    motherPhotos: ['ch8title', 'ch8p1', 'ch8q', 'ch8p2', 'ch8p3'],
    endPhoto: ['ch9title', 'ch9p1', 'ch9p2', 'ch9p3'],
  };

  let html = '<h1>Življenjepis</h1>';
  html += `
    <div class="save-bar">
      <button class="btn btn-accent" onclick="saveSection('biography', collectBiographyData)">Shrani</button>
      <button class="btn btn-outline btn-sm" onclick="translateAllToEN()">Prevedi vse v EN</button>
      <button class="btn btn-history btn-sm" onclick="showHistory('biography')">&#x1F552; Zgodovina</button>
    </div>
  `;

  chapters.forEach(ch => {
    const photos = d[ch.key] || [];
    let photosHtml = '';
    photos.forEach((img, i) => {
      photosHtml += `
        <div class="img-row" data-bio-img="${ch.key}-${i}">
          <img src="${esc(img)}" class="img-preview img-preview-sm" onerror="this.style.display='none'">
          <input type="text" class="bio-${ch.key}-img" value="${esc(img)}" style="flex:1">
          <button class="btn btn-outline btn-sm" onclick="uploadForInput(this, 'bio-${ch.key}-img')">Naloži</button>
          <button class="btn btn-danger btn-sm" onclick="removeBioPhoto('${ch.key}', ${i})">&#x2715;</button>
        </div>
      `;
    });

    // Build chapter texts
    let textsHtml = '';
    const textKeys = chapterTexts[ch.key] || [];
    if (textKeys.length > 0) {
      textsHtml = '<div class="trans-pair-group"><h4>Besedila poglavja (SL / EN)</h4>';
      textKeys.forEach(tk => {
        let label = tk;
        let opts = {};
        if (tk.endsWith('title') || tk.includes('title')) {
          label = 'Naslov';
        } else if (tk.endsWith('q') || tk.match(/q$/)) {
          label = 'Citat';
        } else {
          label = 'Odstavek (' + tk + ')';
          opts = { textarea: true };
        }
        textsHtml += renderTransPair(label, 'about.bio.' + tk, opts);
      });
      textsHtml += '</div>';
    }

    html += `
      <div class="card">
        <div class="card-header">
          <h3>${esc(ch.label)} (${photos.length})</h3>
          <button class="btn btn-outline btn-sm" onclick="addBioPhoto('${ch.key}')">+ Dodaj</button>
        </div>
        <div id="bio-${ch.key}-list">${photosHtml}</div>
        ${textsHtml}
      </div>
    `;
  });

  document.getElementById('section-biography').innerHTML = html;
}

function collectBiographyData() {
  const chapters = ['birthPhotos','firstMonthsPhotos','singingWithMomPhotos','fatherPhotos',
    'musicalTalentPhotos','autisticPhotos','careerPhotos','motherPhotos','endPhoto'];
  const result = {};
  chapters.forEach(ch => {
    const imgs = [];
    document.querySelectorAll('.bio-' + ch + '-img').forEach(inp => {
      const v = inp.value.trim();
      if (v) imgs.push(v);
    });
    result[ch] = imgs;
  });
  return result;
}

function addBioPhoto(chKey) {
  const d = sectionData.biography.data;
  d[chKey] = d[chKey] || [];
  d[chKey].push('');
  renderBiography();
}

function removeBioPhoto(chKey, i) {
  sectionData.biography.data[chKey].splice(i, 1);
  renderBiography();
}

// ---- 9. CONTACT ----
function renderContact() {
  const d = sectionData.contact.data;
  const emailjs = d.emailjs || {};
  const social = d.social || {};

  document.getElementById('section-contact').innerHTML = `
    <h1>Kontakt</h1>
    <div class="save-bar">
      <button class="btn btn-accent" onclick="saveSection('contact', collectContactData)">Shrani</button>
      <button class="btn btn-outline btn-sm" onclick="translateAllToEN()">Prevedi vse v EN</button>
      <button class="btn btn-history btn-sm" onclick="showHistory('contact')">&#x1F552; Zgodovina</button>
    </div>
    <div class="card">
      <h3 style="margin-bottom:16px">Besedila sekcije</h3>
      ${renderTransPair('Nadnaslov', 'contact.supra')}
      ${renderTransPair('Naslov', 'contact.heading')}
      ${renderTransPair('Podnaslov', 'contact.subtitle', {textarea:true})}
      ${renderTransPair('Ime (oznaka)', 'contact.formName')}
      ${renderTransPair('E-pošta (oznaka)', 'contact.formEmail')}
      ${renderTransPair('Sporočilo (oznaka)', 'contact.formMessage')}
      ${renderTransPair('Gumb pošlji', 'contact.formSend')}
    </div>
    <div class="card">
      <h3 style="margin-bottom:16px">EmailJS</h3>
      <div class="field">
        <label for="contact-serviceId">Service ID</label>
        <input type="text" id="contact-serviceId" value="${esc(emailjs.serviceId || '')}" placeholder="service_xxx">
      </div>
      <div class="field">
        <label for="contact-templateId">Template ID</label>
        <input type="text" id="contact-templateId" value="${esc(emailjs.templateId || '')}" placeholder="template_xxx">
      </div>
      <div class="field">
        <label for="contact-publicKey">Public Key</label>
        <input type="text" id="contact-publicKey" value="${esc(emailjs.publicKey || '')}" placeholder="xxx">
      </div>
    </div>
    <div class="card">
      <h3 style="margin-bottom:16px">Socialna omrežja</h3>
      <div class="field">
        <label for="contact-youtube">YouTube URL</label>
        <input type="url" id="contact-youtube" value="${esc(social.youtube || '')}" placeholder="https://youtube.com/...">
      </div>
      <div class="field">
        <label for="contact-facebook">Facebook URL</label>
        <input type="url" id="contact-facebook" value="${esc(social.facebook || '')}" placeholder="https://facebook.com/...">
      </div>
    </div>
  `;
}

function collectContactData() {
  return {
    emailjs: {
      serviceId: val('contact-serviceId'),
      templateId: val('contact-templateId'),
      publicKey: val('contact-publicKey'),
    },
    social: {
      youtube: val('contact-youtube'),
      facebook: val('contact-facebook'),
    }
  };
}

// ---- 10. TRANSLATIONS (slimmed down — only non-inline sections) ----
function renderTranslations() {
  if (!translationsSl || !translationsEn) {
    document.getElementById('section-translations').innerHTML = '<p style="color:var(--muted)">Prevodi še niso naloženi.</p>';
    return;
  }

  const inlineSections = ['hero', 'about', 'encounters', 'gallery', 'music', 'studio', 'collections', 'contact'];
  const allKeys = new Set([...Object.keys(translationsSl || {}), ...Object.keys(translationsEn || {})]);
  const sections = [];
  // Only show sections NOT handled inline
  allKeys.forEach(k => { if (!inlineSections.includes(k)) sections.push(k); });

  let html = '<h1>Prevodi</h1>';
  html += `
    <div class="save-bar">
      <button class="btn btn-accent" onclick="saveTranslations()">Shrani prevode</button>
      <button class="btn btn-outline btn-sm" onclick="translateAllToEN()">Prevedi vse v EN</button>
      <button class="btn btn-history btn-sm" onclick="showHistory('messages-sl')">&#x1F552; SL zgodovina</button>
      <button class="btn btn-history btn-sm" onclick="showHistory('messages-en')">&#x1F552; EN zgodovina</button>
    </div>
  `;

  sections.forEach((sectionKey, si) => {
    const slSection = translationsSl[sectionKey];
    const enSection = translationsEn[sectionKey];

    if (slSection === undefined && enSection === undefined) return;

    // If it's a simple string, not an object
    if (typeof slSection !== 'object' && typeof enSection !== 'object') {
      html += `
        <div class="card">
          <div class="trans-row" style="border-bottom:none">
            <div class="trans-key">${esc(sectionKey)}</div>
            <div class="field" style="margin-bottom:0">
              <label>SL</label>
              <input type="text" data-trans-path="${esc(sectionKey)}" data-trans-lang="sl" value="${esc(slSection || '')}">
            </div>
            <div class="field" style="margin-bottom:0">
              <label>EN</label>
              <input type="text" data-trans-path="${esc(sectionKey)}" data-trans-lang="en" value="${esc(enSection || '')}">
            </div>
          </div>
        </div>
      `;
      return;
    }

    html += `
      <div class="trans-section">
        <div class="trans-section-header" onclick="toggleTransSection(this)" id="trans-header-${si}">
          <span class="arrow">&#x25B6;</span> ${esc(sectionKey)}
        </div>
        <div class="trans-body" id="trans-body-${si}">
          ${renderTransKeys(sectionKey, slSection || {}, enSection || {})}
        </div>
      </div>
    `;
  });

  document.getElementById('section-translations').innerHTML = html;
}

function renderTransKeys(prefix, slObj, enObj) {
  let html = '';
  const allKeys = new Set([...Object.keys(slObj || {}), ...Object.keys(enObj || {})]);

  allKeys.forEach(key => {
    const slVal = slObj ? slObj[key] : undefined;
    const enVal = enObj ? enObj[key] : undefined;
    const path = prefix + '.' + key;

    // If both are objects, recurse
    if ((typeof slVal === 'object' && slVal !== null) || (typeof enVal === 'object' && enVal !== null)) {
      html += `
        <div style="margin-left:12px;margin-top:8px;margin-bottom:8px">
          <div style="font-weight:600;color:var(--accent);font-size:.85rem;margin-bottom:6px">${esc(key)}</div>
          ${renderTransKeys(path, slVal || {}, enVal || {})}
        </div>
      `;
      return;
    }

    // Leaf value
    const isLong = (String(slVal || '').length > 80 || String(enVal || '').length > 80);

    const tBtnHtml = '<button class="btn-translate" onclick="event.stopPropagation();translateField(this)" title="Prevedi SL \u2192 EN" style="margin-left:6px">\u2192 EN</button>';

    if (isLong) {
      html += `
        <div class="trans-row">
          <div class="trans-key">${esc(path)}</div>
          <div class="field" style="margin-bottom:0">
            <label>SL</label>
            <textarea data-trans-path="${esc(path)}" data-trans-lang="sl" rows="3">${esc(slVal || '')}</textarea>
          </div>
          <div class="field" style="margin-bottom:0">
            <label style="display:flex;justify-content:space-between;align-items:center"><span>EN</span> ${tBtnHtml}</label>
            <textarea data-trans-path="${esc(path)}" data-trans-lang="en" rows="3">${esc(enVal || '')}</textarea>
          </div>
        </div>
      `;
    } else {
      html += `
        <div class="trans-row">
          <div class="trans-key">${esc(path)}</div>
          <div class="field" style="margin-bottom:0">
            <label>SL</label>
            <input type="text" data-trans-path="${esc(path)}" data-trans-lang="sl" value="${esc(slVal || '')}">
          </div>
          <div class="field" style="margin-bottom:0">
            <label style="display:flex;justify-content:space-between;align-items:center"><span>EN</span> ${tBtnHtml}</label>
            <input type="text" data-trans-path="${esc(path)}" data-trans-lang="en" value="${esc(enVal || '')}">
          </div>
        </div>
      `;
    }
  });

  return html;
}

function toggleTransSection(header) {
  header.classList.toggle('open');
  const body = header.nextElementSibling;
  body.classList.toggle('open');
}

function collectTranslationsData() {
  const sl = JSON.parse(JSON.stringify(translationsSl));
  const en = JSON.parse(JSON.stringify(translationsEn));

  document.querySelectorAll('[data-trans-path]').forEach(input => {
    const path = input.getAttribute('data-trans-path');
    const lang = input.getAttribute('data-trans-lang');
    const value = input.tagName === 'TEXTAREA' ? input.value : input.value;
    const target = lang === 'sl' ? sl : en;
    setNestedValue(target, path, value);
  });

  return { sl, en };
}

async function saveTranslations() {
  try {
    const { sl, en } = collectTranslationsData();

    const [slRes, enRes] = await Promise.all([
      apiPut('messages-sl', sl, translationsSlSha),
      apiPut('messages-en', en, translationsEnSha),
    ]);

    translationsSl = sl;
    translationsEn = en;
    translationsSlSha = slRes.sha;
    translationsEnSha = enRes.sha;
    showToast('Prevodi shranjeni!');
  } catch (e) {
    showToast('Napaka: ' + e.message, 'error');
  }
}

// ---- Upload helper for inputs near the button ----
async function uploadForInput(btn, inputClass) {
  try {
    const url = await uploadImage();
    // Find the input in the same parent row
    const container = btn.closest('.img-row') || btn.closest('.field');
    const input = container.querySelector('.' + inputClass) || container.querySelector('input[type=text]');
    if (input) {
      input.value = url;
      // Update preview if exists
      const preview = container.querySelector('.img-preview');
      if (preview) {
        preview.src = url;
        preview.style.display = '';
      }
    }
  } catch (e) {
    // Upload cancelled or failed - toast already shown
  }
}

// ---- VERSION HISTORY ----
async function showHistory(fileKey) {
  const sec = SECTIONS.find(s => s.file === fileKey);
  const label = sec ? sec.label : fileKey;

  // Create modal
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
  overlay.innerHTML = `
    <div class="modal-box">
      <div class="modal-header">
        <h2>Zgodovina: ${esc(label)}</h2>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
      </div>
      <div class="modal-body" id="history-body">
        <div class="history-loading">Nalagam zgodovino...</div>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);

  try {
    const r = await fetch('/api/content?file=' + encodeURIComponent(fileKey) + '&action=history', {
      headers: { 'Authorization': 'Bearer ' + getToken() }
    });
    if (r.status === 401) { doLogout(); return; }
    const d = await r.json();
    if (!d.history || d.history.length === 0) {
      document.getElementById('history-body').innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px">Ni zgodovine.</p>';
      return;
    }
    renderHistory(fileKey, d.history);
  } catch (e) {
    document.getElementById('history-body').innerHTML = '<p style="color:var(--danger);text-align:center;padding:40px">Napaka: ' + esc(e.message) + '</p>';
  }
}

function renderHistory(fileKey, history) {
  const body = document.getElementById('history-body');
  let html = '';
  history.forEach((item, i) => {
    const date = new Date(item.date);
    const dateStr = date.toLocaleDateString('sl-SI', { day: '2-digit', month: '2-digit', year: 'numeric' })
      + ' ' + date.toLocaleTimeString('sl-SI', { hour: '2-digit', minute: '2-digit' });
    const isCurrent = i === 0;
    html += `
      <div class="history-item ${isCurrent ? 'current' : ''}" onclick="${isCurrent ? '' : "restoreVersion('" + fileKey + "','" + item.sha + "')"}">
        <div class="history-meta">
          <div class="history-date">${esc(dateStr)}</div>
          <div class="history-msg">${esc(item.message)}</div>
        </div>
        ${isCurrent
          ? '<span class="history-badge history-badge-current">Trenutna</span>'
          : '<span class="history-badge history-badge-restore">Povrni</span>'}
      </div>
    `;
  });
  body.innerHTML = html;
}

async function restoreVersion(fileKey, commitSha) {
  if (!confirm('Povrniti to verzijo? Trenutna vsebina bo nadomeščena.')) return;

  const sec = SECTIONS.find(s => s.file === fileKey);
  const sKey = sec ? sec.key : fileKey;

  try {
    showToast('Povračam verzijo...');

    // Get the old version's content
    const vRes = await fetch('/api/content?file=' + encodeURIComponent(fileKey) + '&action=version&ref=' + encodeURIComponent(commitSha), {
      headers: { 'Authorization': 'Bearer ' + getToken() }
    });
    if (!vRes.ok) throw new Error('Napaka pri branju stare verzije');
    const vData = await vRes.json();

    // Get current SHA for the file
    const cRes = await fetch('/api/content?file=' + encodeURIComponent(fileKey), {
      headers: { 'Authorization': 'Bearer ' + getToken() }
    });
    if (!cRes.ok) throw new Error('Napaka pri branju trenutne verzije');
    const cData = await cRes.json();

    // Save old version as current
    const result = await apiPut(fileKey, vData.data, cData.sha);

    // Update local state
    if (sKey === 'messages-sl') {
      translationsSl = vData.data;
      translationsSlSha = result.sha;
    } else if (sKey === 'messages-en') {
      translationsEn = vData.data;
      translationsEnSha = result.sha;
    } else {
      sectionData[sKey] = { data: vData.data, sha: result.sha };
    }

    // Close modal, re-render, notify
    document.querySelector('.modal-overlay')?.remove();
    if (sKey === 'translations' || sKey === 'messages-sl' || sKey === 'messages-en') {
      renderTranslations();
    } else {
      renderSection(sKey);
    }
    showToast('Verzija povrnjena!');
  } catch (e) {
    showToast('Napaka: ' + e.message, 'error');
  }
}

// ---- Init ----
(function init() {
  if (getToken()) {
    showApp();
  }
})();
</script>
</body>
</html>
